<!DOCTYPE html>
<html>
<head>
<title>Check-in Equipe</title>
</head>
<body>
<h2>Check-in</h2>

<input type="text" id="nome" placeholder="Nome Completo" required>
<br><br>
<input type="text" id="cpf" placeholder="CPF (somente números)" inputmode="numeric" required>
<br><br>

<button id="btnCheckin" onclick="checkin()">Fazer Check-in</button>

<p id="status"></p>

<script>
const estadioLat = -22.89520;  // COLOQUE AQUI LATITUDE REAL
const estadioLon = -43.29314;  // COLOQUE AQUI LONGITUDE REAL
const raio = 500; // metros

function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

function normalizarCpf(v) {
  return (v || "").toString().replace(/\D/g, "");
}

function cpfValido(cpf) {
  cpf = normalizarCpf(cpf);
  if (cpf.length !== 11) return false;
  if (/^(\d)\1+$/.test(cpf)) return false;

  let soma = 0;
  for (let i = 0; i < 9; i++)
    soma += parseInt(cpf.charAt(i)) * (10 - i);

  let resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  if (resto !== parseInt(cpf.charAt(9))) return false;

  soma = 0;
  for (let i = 0; i < 10; i++)
    soma += parseInt(cpf.charAt(i)) * (11 - i);

  resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  if (resto !== parseInt(cpf.charAt(10))) return false;

  return true;
}

async function checkin() {
  if (enviando) return;

  const statusEl = document.getElementById("status");
  const btn = document.getElementById("btnCheckin");
  const nomeEl = document.getElementById("nome");
  const cpfEl = document.getElementById("cpf");

  const nome = nomeEl.value.trim();
  const cpf = normalizarCpf(cpfEl.value);

  if (!nome) {
    alert("Nome completo é obrigatório.");
    return;
  }

  if (!cpfValido(cpf)) {
    alert("CPF inválido.");
    return;
  }

  enviando = true;
  btn.disabled = true;
  statusEl.innerText = "Validando localização...";

  navigator.geolocation.getCurrentPosition(async (position) => {
    const lat = position.coords.latitude;
    const lon = position.coords.longitude;
    const distancia = calcularDistancia(lat, lon, estadioLat, estadioLon);

    if (distancia > raio) {
      statusEl.innerText = "Fora do raio permitido (100m).";
      btn.disabled = false;
      enviando = false;
      return;
    }

    statusEl.innerText = "Enviando...";

    try {
      const res = await fetch("https://script.google.com/macros/s/AKfycbwJUT41-0Sq3T_pRImLMtXK87skbOaUyoce8Tk_nTCFNcEtz4x-fQhoSd7VJO5n21Op/exec", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({
          nome,
          cpf,
          latitude: lat,
          longitude: lon,
          distancia: Math.round(distancia)
        })
      });

      const text = await res.text();

      if (text === "DUPLICADO_DIA") {
        statusEl.innerText = "CPF já registrou presença hoje.";
      } else {
        statusEl.innerText = "Check-in realizado com sucesso!";
      }

      btn.disabled = true;
      nomeEl.disabled = true;
      cpfEl.disabled = true;

    } catch (e) {
      statusEl.innerText = "Erro no envio.";
      btn.disabled = false;
      enviando = false;
    }

  }, () => {
    alert("Permita a localização.");
    btn.disabled = false;
    enviando = false;
  }, { enableHighAccuracy: true });

}

</script>

</body>
</html>
