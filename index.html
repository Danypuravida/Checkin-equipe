<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Check-in Equipe</title>
<style>
body { font-family: Arial; padding: 30px; text-align: center; }
input, button { padding: 10px; width: 250px; }
button { cursor: pointer; }
#status { margin-top: 20px; font-weight: bold; }
</style>
</head>
<body>

<h2>Check-in</h2>

<input type="text" id="nome" placeholder="Nome completo" required>
<br><br>

<input type="text" id="cpf" placeholder="CPF (somente nÃºmeros)" inputmode="numeric" required>
<br><br>

<button id="btnCheckin" onclick="checkin()">Fazer Check-in</button>

<p id="status"></p>

<script>

// =====================
// ðŸ”´ PREENCHA AQUI
// =====================

const estadioLat = -22.89520;   // COLOQUE A LATITUDE REAL
const estadioLon = -43.29314;   // COLOQUE A LONGITUDE REAL
const raio = 500; // metros

const APPS_SCRIPT_URL = "https://script.google.com/macros/s/AKfycbwJUT41-0Sq3T_pRImLMtXK87skbOaUyoce8Tk_nTCFNcEtz4x-fQhoSd7VJO5n21Op/exec";

// =====================

let enviando = false;

function setStatus(msg) {
  document.getElementById("status").innerText = msg;
}

function normalizarCpf(v) {
  return (v || "").toString().replace(/\D/g, "");
}

function cpfValido(cpf) {
  cpf = normalizarCpf(cpf);
  if (cpf.length !== 11) return false;
  if (/^(\d)\1+$/.test(cpf)) return false;

  let soma = 0;
  for (let i = 0; i < 9; i++)
    soma += parseInt(cpf.charAt(i)) * (10 - i);

  let resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  if (resto !== parseInt(cpf.charAt(9))) return false;

  soma = 0;
  for (let i = 0; i < 10; i++)
    soma += parseInt(cpf.charAt(i)) * (11 - i);

  resto = (soma * 10) % 11;
  if (resto === 10) resto = 0;
  if (resto !== parseInt(cpf.charAt(10))) return false;

  return true;
}

function calcularDistancia(lat1, lon1, lat2, lon2) {
  const R = 6371000;
  const dLat = (lat2-lat1) * Math.PI/180;
  const dLon = (lon2-lon1) * Math.PI/180;
  const a = Math.sin(dLat/2) * Math.sin(dLat/2) +
            Math.cos(lat1*Math.PI/180) * Math.cos(lat2*Math.PI/180) *
            Math.sin(dLon/2) * Math.sin(dLon/2);
  const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a));
  return R * c;
}

async function checkin() {

  if (enviando) return;

  const btn = document.getElementById("btnCheckin");
  const nomeEl = document.getElementById("nome");
  const cpfEl = document.getElementById("cpf");

  const nome = nomeEl.value.trim();
  const cpf = normalizarCpf(cpfEl.value);

  if (!nome) {
    alert("Nome completo Ã© obrigatÃ³rio.");
    return;
  }

  if (!cpfValido(cpf)) {
    alert("CPF invÃ¡lido.");
    return;
  }

  if (APPS_SCRIPT_URL.includes("COLE_AQUI")) {
    alert("VocÃª ainda nÃ£o colou a URL do Apps Script.");
    return;
  }

  enviando = true;
  btn.disabled = true;
  setStatus("Validando localizaÃ§Ã£o...");

  if (!navigator.geolocation) {
    setStatus("GeolocalizaÃ§Ã£o nÃ£o suportada.");
    btn.disabled = false;
    enviando = false;
    return;
  }

  navigator.geolocation.getCurrentPosition(
    async (position) => {

      const lat = position.coords.latitude;
      const lon = position.coords.longitude;

      const distancia = calcularDistancia(lat, lon, estadioLat, estadioLon);

      if (distancia > raio) {
        setStatus("Fora do raio permitido (100m). Check-in bloqueado.");
        btn.disabled = false;
        enviando = false;
        return;
      }

      setStatus("Enviando check-in...");

      try {
        const res = await fetch(APPS_SCRIPT_URL, {
  method: "POST",
  body: JSON.stringify({
    nome: nome,
    cpf: cpf,
    latitude: lat,
    longitude: lon,
    distancia: Math.round(distancia)
  })
});
        const text = await res.text();

        if (text === "DUPLICADO_DIA") {
          setStatus("âœ… CPF jÃ¡ registrou presenÃ§a hoje.");
        } else if (text === "OK") {
          setStatus("âœ… Check-in realizado com sucesso!");
        } else {
          setStatus("Resposta do servidor: " + text);
        }

        nomeEl.disabled = true;
        cpfEl.disabled = true;
        btn.disabled = true;

      } catch (err) {
        setStatus("Erro no envio. Verifique a internet.");
        btn.disabled = false;
        enviando = false;
      }

    },
    (error) => {
      setStatus("Erro de localizaÃ§Ã£o: " + error.message);
      btn.disabled = false;
      enviando = false;
    },
    { enableHighAccuracy: true, timeout: 15000, maximumAge: 0 }
  );
}

</script>

</body>
</html>
